<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>解忧杂货铺</title>
    <!-- 引入marked库，确保在脚本执行前加载 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- 页面样式 -->
    <style>
        /* 全局样式重置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* 页面基础样式 */
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #f6f9fc 0%, #edf1f7 100%);
            color: #2c3e50;
            min-height: 100vh;
        }

        /* 页面布局 */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* 页面头部 */
        header {
            text-align: center;
            padding: 30px 0;
            margin-bottom: 30px;
            animation: fadeInDown 0.8s ease-out;
        }

        header h1 {
            color: #1a365d;
            font-size: 2.5em;
            margin-bottom: 15px;
            letter-spacing: -0.5px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        header p {
            color: #4a5568;
            font-size: 1.2em;
            opacity: 0.9;
        }

        /* 聊天区域 */
        .chat-container {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .chat-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
        }

        /* 消息列表 */
        .messages {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        /* 消息气泡 */
        .message {
            margin-bottom: 25px;
            display: flex;
            align-items: flex-start;
            animation: fadeInUp 0.5s ease-out;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-content {
            max-width: 70%;
            padding: 25px 30px;
            margin: 0 15px;
            background: #fff;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            position: relative;
            font-family: 'Times New Roman', serif;
            line-height: 1.6;
            background-image: linear-gradient(0deg, #f7fafc 1px, transparent 1px);
            background-size: 100% 2em;
            border-radius: 3px;
            transition: transform 0.2s ease;
        }

        .message-content:hover {
            transform: scale(1.02);
        }

        .user .message-content {
            color: #2d3748;
            border-top-right-radius: 15px;
            border-bottom-left-radius: 15px;
            transform-origin: top right;
        }
        
        .user .message-content::before {
            content: '';
            position: absolute;
            top: -10px;
            right: -10px;
            width: 20px;
            height: 20px;
            background: #4299e1;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(66, 153, 225, 0.3);
        }

        .assistant .message-content {
            color: #2d3748;
            border-top-left-radius: 15px;
            border-bottom-right-radius: 15px;
            transform-origin: top left;
        }
        
        .assistant .message-content::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            width: 20px;
            height: 20px;
            background: #3182ce;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(49, 130, 206, 0.3);
        }

        /* 输入区域 */
        .input-container {
            padding: 25px;
            background: rgba(255, 255, 255, 0.9);
            border-top: 1px solid rgba(226, 232, 240, 0.8);
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .input-container textarea {
            flex: 1;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            resize: none;
            height: 60px;
            font-family: inherit;
            font-size: 1em;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.95);
        }

        .input-container textarea:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
        }

        .input-container button {
            padding: 0 25px;
            height: 45px;
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: #fff;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11);
        }

        .input-container button:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
            background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
        }

        /* 信件样式 */
        .letter-style {
            background-color: #fffef7 !important;
            background-image: linear-gradient(0deg, #f0e6d2 1px, transparent 1px) !important;
            border: 1px solid #d3b17d !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1) !important;
            font-family: 'Times New Roman', serif !important;
            padding: 30px !important;
            position: relative;
            animation: letter-appear 0.5s ease-out;
        }
        
        @keyframes letter-appear {
            0% {
                opacity: 0;
                transform: scale(0.95) rotate(-1deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotate(0);
            }
        }
        
        .user .letter-style::after {
            content: '';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23d3b17d"><path d="M20,4H4C2.9,4,2,4.9,2,6v12c0,1.1,0.9,2,2,2h16c1.1,0,2-0.9,2-2V6C22,4.9,21.1,4,20,4z M20,8l-8,5L4,8V6l8,5l8-5V8z"/></svg>');
            background-size: contain;
            opacity: 0.7;
        }
        
        .assistant .letter-style::after {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            width: 30px;
            height: 30px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%233182ce"><path d="M20,4H4C2.9,4,2,4.9,2,6v12c0,1.1,0.9,2,2,2h16c1.1,0,2-0.9,2-2V6C22,4.9,21.1,4,20,4z M20,8l-8,5L4,8V6l8,5l8-5V8z"/></svg>');
            background-size: contain;
            opacity: 0.7;
        }
        
        /* 思考中的动画效果 */
        .thinking .message-content {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: #fff;
            animation: thinking 2s ease-in-out infinite;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(50, 50, 93, 0.15);
            transition: all 0.3s ease;
        }

        .thinking .message-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }
        
        /* 加载动画样式 */
        .loading-dots {
            display: inline-block;
            margin-top: 10px;
            text-align: center;
            width: 100%;
        }
        
        .loading-dots span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #3182ce;
            margin: 0 3px;
            opacity: 0.6;
            animation: loadingDots 1.4s infinite ease-in-out both;
        }
        
        .loading-dots span:nth-child(1) {
            animation-delay: 0s;
        }
        
        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes loadingDots {
            0%, 80%, 100% {
                transform: scale(0.6);
                opacity: 0.4;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes thinking {
            0% {
                transform: scale(1);
                opacity: 0.8;
                box-shadow: 0 4px 15px rgba(50, 50, 93, 0.15);
            }
            50% {
                transform: scale(1.02);
                opacity: 1;
                box-shadow: 0 8px 20px rgba(50, 50, 93, 0.2);
            }
            100% {
                transform: scale(1);
                opacity: 0.8;
                box-shadow: 0 4px 15px rgba(50, 50, 93, 0.15);
            }
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* 动画效果 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 历史对话信箱样式 */
        .mailbox-container {
            position: fixed;
            top: 0;
            right: -350px; /* 初始隐藏在右侧 */
            width: 350px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.97);
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: right 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .mailbox-container.active {
            right: 0;
        }

        .mailbox-header {
            padding: 20px;
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mailbox-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .close-mailbox {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
        }

        .mailbox-search {
            padding: 15px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .mailbox-search input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .mailbox-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .mail-item {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background 0
            .3s ease;
            position: relative;
        }

        .mail-item:hover {
            background: #f7fafc;
        }

        .mail-item .mail-time {
            font-size: 0.8em;
            color: #718096;
            margin-bottom: 5px;
        }

        .mail-item .mail-preview {
            color: #4a5568;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mail-item .delete-mail {
            position: absolute;
            right: 15px;
            top: 15px;
            color: #e53e3e;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .mail-item:hover .delete-mail {
            opacity: 1;
        }

        /* 新信件按钮样式 */
        .new-letter-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            transition: all 0.3s ease;
            z-index: 900;
        }

        .new-letter-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        /* 信箱图标按钮 */
        .mailbox-btn {
            position: fixed;
            bottom: 30px;
            right: 110px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            transition: all 0.3s ease;
            z-index: 900;
        }

        .mailbox-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        /* 响应式设计 */
        @media (max-width: 600px) {
            .container {
                padding: 20px 10px;
            }

            .message-content {
                max-width: 85%;
            }

            header h1 {
                font-size: 2em;
            }

            .input-container {
                padding: 15px;
            }

            .input-container textarea {
                height: 50px;
            }

            .mailbox-container {
                width: 100%;
                right: -100%;
            }

            .new-letter-btn,
            .mailbox-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2em;
            }

            .mailbox-btn {
                right: 90px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 页面头部 -->
        <header>
            <h1>解忧杂货铺</h1>
            <p>倾听烦恼，温暖你心</p>
        </header>

        <!-- 聊天区域 -->
        <div class="chat-container">
            <!-- 消息列表 -->
            <div class="messages" id="messages">
                <!-- AI 欢迎消息 -->
                <div class="message assistant">
                    <div class="message-content">
                        🌙 深夜的杂货店亮着灯<br>
                        你好，这里是浪矢爷爷的"解忧信箱"。<br>
                        你可以写下任何心事——关于生活、选择、遗憾，或是某个难以启齿的秘密。<br>
                        请相信："你的地图是白纸，所以一切皆有可能。"<br>
                        我们会像对待30年前的信件一样，认真回复你的每一个字。
                    </div>
                </div>
            </div>

            <!-- 输入区域 -->
            <div class="input-container">
                <textarea id="userInput" placeholder="输入你的问题或想法..."></textarea>
                <button id="sendButton">发送</button>
            </div>
        </div>
    </div>

    <!-- 历史对话信箱 -->
    <div class="mailbox-container" id="mailboxContainer">
        <div class="mailbox-header">
            <h2>历史对话信箱</h2>
            <button class="close-mailbox" id="closeMailbox">×</button>
        </div>
        <div class="mailbox-search">
            <input type="text" id="mailSearch" placeholder="搜索历史对话...">
        </div>
        <div class="mailbox-list" id="mailboxList">
            <!-- 历史对话项将通过JavaScript动态添加 -->
        </div>
    </div>

    <!-- 新信件按钮 -->
    <button class="new-letter-btn" id="newLetterBtn" title="寄出新的信件">✉️</button>

    <!-- 信箱按钮 -->
    <button class="mailbox-btn" id="mailboxBtn" title="查看历史对话">📬</button>

    <!-- 页面脚本 -->
    <script>
        // 获取DOM元素
        const messagesContainer = document.getElementById('messages');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const mailboxContainer = document.getElementById('mailboxContainer');
        const closeMailbox = document.getElementById('closeMailbox');
        const mailboxBtn = document.getElementById('mailboxBtn');
        const newLetterBtn = document.getElementById('newLetterBtn');
        const mailboxList = document.getElementById('mailboxList');
        const mailSearch = document.getElementById('mailSearch');
        
        // 当前会话ID
        let currentSessionId = generateSessionId();
        
        // 生成会话ID
        function generateSessionId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // 轮询检查认知分析是否已生成的函数
        async function pollForCognitiveResponse(sessionId, transitionMessageDiv) {
            let attempts = 0;
            const maxAttempts = 120; // 增加最大尝试次数到120次，提供更长的等待时间（最多4分钟）
            const initialPollInterval = 1500; // 初始轮询间隔1.5秒，提高初始响应速度
            const maxPollInterval = 6000; // 最大轮询间隔6秒，避免间隔过长
            let currentPollInterval = initialPollInterval;
            let consecutiveErrors = 0;
            const maxConsecutiveErrors = 3; // 最大连续错误次数
            let isProcessing = false; // 添加处理状态标志
            let hasReceivedResponse = false; // 标记是否已收到有效回复
            
            // 记录轮询开始时间，用于计算总轮询时间
            const pollStartTime = new Date();
            console.log('开始轮询认知分析，开始时间:', pollStartTime.toISOString())
            
            // 显示加载状态
            const contentDiv = transitionMessageDiv.querySelector('.message-content');
            contentDiv.innerHTML += '<div class="loading-dots"><span>.</span><span>.</span><span>.</span></div>';
            
            // 添加用户反馈机制
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = 'feedback-container';
            feedbackDiv.innerHTML = `
                <button class="feedback-btn" id="reportIssueBtn" title="报告问题">⚠️ 回复显示问题</button>
            `;
            feedbackDiv.style.display = 'none';
            transitionMessageDiv.appendChild(feedbackDiv);
            
            const checkCognitive = async () => {
                // 如果已经在处理中，则跳过本次检查
                if (isProcessing) {
                    console.log('上一次请求仍在处理中，跳过本次检查');
                    return false;
                }
                
                isProcessing = true; // 标记为处理中
                
                try {
                    // 发送请求检查认知分析是否已生成
                    const baseUrl = window.location.origin;
                    const apiUrl = `${baseUrl}/api/check-cognitive`;
                    console.log(`检查认知分析请求 (尝试 ${attempts + 1}/${maxAttempts}):`, {
                        url: apiUrl,
                        sessionId: sessionId
                    });
                    
                    // 设置请求超时
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => {
                        controller.abort();
                        console.log('检查认知分析请求超时 (8秒)');
                    }, 8000);
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ sessionId: sessionId }),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        console.log(`检查认知分析时出错 (HTTP ${response.status})，将继续轮询`);
                        consecutiveErrors++;
                        // 如果连续错误次数过多，增加轮询间隔
                        if (consecutiveErrors >= maxConsecutiveErrors) {
                            currentPollInterval = Math.min(currentPollInterval * 1.5, maxPollInterval);
                            console.log(`连续错误次数过多，增加轮询间隔至 ${currentPollInterval}ms`);
                        }
                        isProcessing = false; // 重置处理状态
                        return false;
                    }
                    
                    // 重置连续错误计数
                    consecutiveErrors = 0;
                    
                    const data = await response.json();
                    console.log('检查认知分析结果:', data);
                    
                    // 如果认知分析已生成，使用更精确的条件判断
                    // 增强识别条件：检查认知回复的标识符、长度和内容特征
                    console.log('认知分析内容检查:', {
                        hasData: !!data,
                        hasCognitive: data && !!data.cognitive,
                        contentLength: data && data.cognitive ? data.cognitive.length : 0,
                        isDefaultResponse: data && data.cognitive === "唉，这件事确实很难办呢，不过没关系，我给你写一封回信慢慢说吧",
                        firstChars: data && data.cognitive ? data.cognitive.substring(0, 30) : ''
                    });
                    
                    // 优化判断条件：只要不是默认回复且长度合理就显示
                    // 如果服务器返回null，表示认知分析尚未生成，继续轮询
                    if (!data || data.cognitive === null || data.cognitive === undefined) {
                        console.log('服务器返回null或undefined，认知分析尚未生成，继续轮询');
                        isProcessing = false;
                        return false;
                    }
                    
                    // 记录详细的认知分析内容信息，便于调试
                    console.log('认知分析内容详情:', {
                        contentType: typeof data.cognitive,
                        contentLength: data.cognitive ? data.cognitive.length : 0,
                        isDefaultResponse: data.cognitive === "唉，这件事确实很难办呢，不过没关系，我给你写一封回信慢慢说吧",
                        firstChars: data.cognitive ? data.cognitive.substring(0, 30) : '',
                        timestamp: new Date().toISOString()
                    });
                    
                    if (data && data.cognitive && 
                        data.cognitive !== "唉，这件事确实很难办呢，不过没关系，我给你写一封回信慢慢说吧" && 
                        data.cognitive.length > 20) { // 提高长度阈值，确保捕获到完整有效回复
                        
                        // 记录接收到的认知分析内容，便于调试
                        console.log('接收到认知分析内容:', data.cognitive.substring(0, 100) + '...');
                        
                        
                        // 标记已收到有效回复
                        hasReceivedResponse = true;
                        
                        // 移除加载动画
                        const loadingDots = contentDiv.querySelector('.loading-dots');
                        if (loadingDots) {
                            contentDiv.removeChild(loadingDots);
                        }
                        
                        // 检查是否为默认回复，如果是则完全清除内容
                        if (contentDiv.dataset.isDefaultResponse === 'true') {
                            console.log('检测到默认回复，将完全替换为认知分析结果');
                            // 移除默认回复标记
                            delete contentDiv.dataset.isDefaultResponse;
                        }
                        
                        // 无论是否为默认回复，都强制清除内容并显示后台回复
                        console.log('强制清除现有内容，显示后台生成的认知回复');
                        
                        // 添加信件样式类
                        contentDiv.classList.add('letter-style');
                        // 完全清除内容，确保没有残留
                        contentDiv.innerHTML = '';
                        contentDiv.textContent = '';
                        
                        // 添加调试标记
                        contentDiv.dataset.responseSource = 'backend';
                        contentDiv.dataset.responseTime = new Date().toISOString();
                        
                        // 使用打字机效果显示认知分析结果
                        typeWriter(contentDiv, data.cognitive, 0, () => {
                            try {
                                // 使用try-catch包裹marked解析，防止出错
                                if (typeof marked !== 'undefined') {
                                    contentDiv.innerHTML = marked.parse(contentDiv.textContent);
                                }
                            } catch (e) {
                                console.error('Markdown解析出错:', e);
                                // 如果解析失败，至少显示原始文本
                                contentDiv.textContent = data.cognitive;
                            }
                            
                            // 记录成功显示的回复到控制台，便于调试
                            console.log('成功显示后台生成的认知回复');
                        });
                        isProcessing = false; // 重置处理状态
                        return true; // 成功获取认知分析
                    }
                    
                    // 如果轮询次数达到一半，减少轮询间隔以提高响应速度
                    if (attempts === Math.floor(maxAttempts / 2)) {
                        currentPollInterval = initialPollInterval;
                        console.log(`轮询已达到一半次数，重置轮询间隔为 ${currentPollInterval}ms`);
                    }
                    
                    isProcessing = false; // 重置处理状态
                    return false; // 认知分析尚未生成
                } catch (error) {
                    console.error('轮询认知分析时出错:', error);
                    consecutiveErrors++;
                    
                    // 如果连续错误次数过多，增加轮询间隔
                    if (consecutiveErrors >= maxConsecutiveErrors) {
                        currentPollInterval = Math.min(currentPollInterval * 1.5, maxPollInterval);
                        console.log(`连续错误次数过多，增加轮询间隔至 ${currentPollInterval}ms`);
                    }
                    
                    isProcessing = false; // 重置处理状态
                    return false;
                }
            };
            
            // 开始轮询
            const poll = async () => {
                console.log(`轮询状态检查: 尝试次数=${attempts}/${maxAttempts}, 已收到回复=${hasReceivedResponse}, 处理中=${isProcessing}`);
                
                // 如果已经收到有效回复，则停止轮询
                if (hasReceivedResponse) {
                    console.log('已收到有效回复，停止轮询');
                    return;
                }
                
                if (attempts >= maxAttempts) {
                    console.log('达到最大轮询次数，停止轮询');
                    // 计算总轮询时间
                    const pollEndTime = new Date();
                    const totalPollTime = (pollEndTime - pollStartTime) / 1000;
                    console.log(`轮询总时间: ${totalPollTime}秒，尝试次数: ${attempts}`);
                    
                    // 确保没有正在处理的请求
                    if (isProcessing) {
                        console.log('等待当前请求完成...');
                        // 等待当前请求完成
                        await new Promise(resolve => setTimeout(resolve, 3000));
                    }
                    
                    // 移除加载动画
                    const loadingDots = contentDiv.querySelector('.loading-dots');
                    if (loadingDots) {
                        contentDiv.removeChild(loadingDots);
                    }
                    
                    // 记录轮询结束状态
                    console.log('轮询结束状态:', {
                        attempts: attempts,
                        hasReceivedResponse: hasReceivedResponse,
                        contentDivText: contentDiv.textContent.substring(0, 50) + '...',
                        contentDivHtml: contentDiv.innerHTML.substring(0, 50) + '...'
                    });
                    
                    // 尝试最后一次检查认知分析，增加重试机制
                    console.log('尝试最后一次检查认知分析...');
                    let finalCheckSuccess = false;
                    
                    // 最后尝试3次，增加成功率
                    for (let i = 0; i < 3; i++) {
                        console.log(`执行最终检查尝试 ${i+1}/3...`);
                        const finalCheck = await checkCognitive();
                        
                        // 如果最后一次检查成功，则不显示超时消息
                        if (finalCheck) {
                            console.log('最终检查成功获取到认知分析');
                            finalCheckSuccess = true;
                            break;
                        }
                        
                        // 如果检查失败但还有重试次数，等待一段时间再试
                        if (i < 2) {
                            console.log(`最终检查尝试 ${i+1} 未成功，等待2秒后重试...`);
                            await new Promise(resolve => setTimeout(resolve, 2000));
                        }
                    }
                    
                    if (finalCheckSuccess) {
                        return;
                    }
                    
                    console.log('所有最终检查尝试均未获取到认知分析，显示友好的超时消息');
                    
                    // 显示友好的超时消息
                    contentDiv.classList.add('letter-style');
                    contentDiv.textContent = '';
                    typeWriter(contentDiv, "亲爱的朋友，\n\n感谢你的来信。我正在思考如何更好地回应你的问题，但似乎需要更多时间。如果方便的话，请稍后再来查看，或者你可以再次表达你的想法，帮助我更好地理解你的处境。\n\n期待再次收到你的来信，\n浪矢爷爷", 0, () => {
                        try {
                            if (typeof marked !== 'undefined') {
                                contentDiv.innerHTML = marked.parse(contentDiv.textContent);
                            }
                        } catch (e) {
                            console.error('Markdown解析出错:', e);
                        }
                        
                        // 显示反馈按钮
                        const feedbackDiv = transitionMessageDiv.querySelector('.feedback-container');
                        if (feedbackDiv) {
                            console.log('显示反馈按钮，允许用户手动触发重新获取回复');
                            feedbackDiv.style.display = 'block';
                            
                            // 添加反馈按钮点击事件
                            const reportBtn = feedbackDiv.querySelector('#reportIssueBtn');
                            if (reportBtn) {
                                reportBtn.addEventListener('click', () => {
                                    // 记录问题
                                    console.log('用户点击了反馈按钮，尝试重新获取回复，会话ID:', sessionId);
                                    // 手动触发一次检查
                                    checkCognitive();
                                    alert('已尝试重新获取回复，如果问题仍然存在，请刷新页面重试。');
                                    
                                    // 可以在这里添加发送反馈到服务器的代码
                                    try {
                                        fetch(`${window.location.origin}/api/feedback`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ 
                                                sessionId: sessionId,
                                                issue: 'cognitive_response_display_issue',
                                                timestamp: new Date().toISOString()
                                            })
                                        }).catch(err => console.error('发送反馈时出错:', err));
                                    } catch (e) {
                                        console.error('发送反馈时出错:', e);
                                    }
                                });
                            }
                        }
                    });
                    return;
                }
                
                attempts++;
                // 添加随机延迟，避免请求同时发送
                const jitter = Math.floor(Math.random() * 500); // 0-500ms的随机延迟
                await new Promise(resolve => setTimeout(resolve, jitter));
                
                const success = await checkCognitive();
                
                if (!success) {
                    // 如果尚未获取到认知分析，继续轮询
                    setTimeout(poll, currentPollInterval);
                }
            };
            
            // 立即开始第一次检查
            setTimeout(poll, initialPollInterval);
        }

        // 发送消息函数
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            // 添加用户消息到界面
            addMessage(message, 'user');
            userInput.value = '';

            // 添加思考中的提示
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'message assistant thinking';
            thinkingDiv.innerHTML = '<div class="message-content">凡事发生皆有利于我</div>';
            messagesContainer.appendChild(thinkingDiv);
            thinkingDiv.style.opacity = '0';
            setTimeout(() => {
                thinkingDiv.style.opacity = '1';
                thinkingDiv.style.transition = 'all 0.5s ease-in-out';
            }, 100);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            try {
                // 发送请求到后端
                const baseUrl = window.location.origin;
                const apiUrl = `${baseUrl}/api/chat`;
                console.log('发送聊天请求URL:', apiUrl);
                
                // 设置请求超时
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    console.log('聊天请求超时 (15秒)');
                    throw new Error('请求超时，请稍后重试');
                }, 15000);
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message, sessionId: currentSessionId }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`服务器响应错误: ${response.status}`);
                }

                const data = await response.json();
                console.log('API Response:', data); // 添加日志

                // 检查错误
                if (data.error) {
                    throw new Error(data.error);
                }

                // 验证响应数据结构
                if (!data || typeof data !== 'object') {
                    throw new Error('服务器返回的数据格式不正确');
                }

                // 移除思考中的提示并显示AI回复
                if (thinkingDiv && thinkingDiv.parentNode) {
                    thinkingDiv.style.opacity = '0';
                    await new Promise(resolve => setTimeout(resolve, 300));
                    messagesContainer.removeChild(thinkingDiv);

                    // 分段显示AI回复
                    const response = data.response || data;
                    if (typeof response === 'string') {
                        // 如果是单个字符串回复
                        await addMessage(response, 'assistant');
                    } else {
                        // 处理三段式回复
                        let cognitiveMessageDiv = null;
                        
                        // 先显示情绪回应
                        if (response.emotional) {
                            await addMessage(response.emotional, 'assistant');
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                        
                        // 显示过渡语并设置一个标识符，以便后续可以替换这条消息
                        let transitionMessageDiv = null;
                        if (response.transition) {
                            await addMessage("你现在心情好了一些吗。", 'assistant');
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            
                            // 创建过渡消息，并保存引用以便后续替换
                            transitionMessageDiv = document.createElement('div');
                            transitionMessageDiv.className = `message assistant`;
                            transitionMessageDiv.dataset.messageType = 'cognitive'; // 添加数据属性标识认知回复
                            transitionMessageDiv.innerHTML = `<div class="message-content"></div>`;
                            transitionMessageDiv.style.opacity = '0';
                            messagesContainer.appendChild(transitionMessageDiv);
                            
                            const contentDiv = transitionMessageDiv.querySelector('.message-content');
                            contentDiv.textContent = '';
                            transitionMessageDiv.style.opacity = '1';
                            transitionMessageDiv.style.transition = 'opacity 0.3s ease-in-out';
                            // 添加默认回复标记，便于后续识别和替换
                            contentDiv.dataset.isDefaultResponse = 'true';
                            typeWriter(contentDiv, "唉，这件事确实很难办呢，不过没关系，我给你写一封回信慢慢说吧", 0, () => {
                                contentDiv.innerHTML = marked.parse(contentDiv.textContent);
                            });
                            
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            
                            // 开始轮询检查认知分析是否已生成
                            if (response.sessionId) {
                                console.log('开始轮询检查认知回复，会话ID:', response.sessionId);
                                pollForCognitiveResponse(response.sessionId, transitionMessageDiv);
                            } else {
                                console.error('缺少会话ID，无法轮询认知回复');
                                // 记录错误日志
                                try {
                                    fetch(`${window.location.origin}/api/log-error`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ 
                                            error: 'missing_session_id',
                                            message: '缺少会话ID，无法轮询认知回复',
                                            timestamp: new Date().toISOString()
                                        })
                                    }).catch(err => console.error('记录错误日志时出错:', err));
                                } catch (e) {
                                    console.error('记录错误日志时出错:', e);
                                }
                            }
                        }
                        
                        // 如果服务器直接返回了认知分析（不太可能，因为认知分析是在后台异步生成的）
                        // 但如果确实返回了，我们应该优先显示它
                        if (response.cognitive && 
                            response.cognitive !== "唉，这件事确实很难办呢，不过没关系，我给你写一封回信慢慢说吧" &&
                            response.cognitive.length > 20) { // 降低长度阈值，确保能捕获到较短的有效回复
                            
                            // 记录直接返回的认知分析内容，便于调试
                            console.log('服务器直接返回的认知分析内容:', response.cognitive.substring(0, 100) + '...');
                            
                            console.log('服务器直接返回了认知分析，优先显示');
                            
                            if (transitionMessageDiv) {
                                // 如果有过渡消息，则替换它
                                const contentDiv = transitionMessageDiv.querySelector('.message-content');
                                
                                // 检查是否为默认回复，如果是则完全清除内容
                                if (contentDiv.dataset.isDefaultResponse === 'true') {
                                    console.log('检测到默认回复，将直接替换为服务器返回的认知分析结果');
                                    // 移除默认回复标记
                                    delete contentDiv.dataset.isDefaultResponse;
                                }
                                
                                // 添加信件样式类
                                contentDiv.classList.add('letter-style');
                                // 完全清除内容，确保没有残留
                                contentDiv.innerHTML = '';
                                contentDiv.textContent = '';
                                
                                typeWriter(contentDiv, response.cognitive, 0, () => {
                                    try {
                                        contentDiv.innerHTML = marked.parse(contentDiv.textContent);
                                    } catch (e) {
                                        console.error('Markdown解析出错:', e);
                                        contentDiv.textContent = response.cognitive;
                                    }
                                });
                            } else {
                                // 否则添加新消息
                                const messageDiv = document.createElement('div');
                                messageDiv.className = 'message assistant';
                                messageDiv.dataset.messageType = 'cognitive'; // 添加数据属性标识认知回复
                                messageDiv.innerHTML = `<div class="message-content letter-style"></div>`;
                                messagesContainer.appendChild(messageDiv);
                                
                                const contentDiv = messageDiv.querySelector('.message-content');
                                typeWriter(contentDiv, response.cognitive, 0, () => {
                                    try {
                                        contentDiv.innerHTML = marked.parse(contentDiv.textContent);
                                    } catch (e) {
                                        console.error('Markdown解析出错:', e);
                                        contentDiv.textContent = response.cognitive;
                                    }
                                });
                            }
                        }
                    }
                }
                
                // 保存对话到历史记录
                saveConversationToHistory();

            } catch (error) {
                console.error('Error:', error);
                // 移除思考中的提示
                if (thinkingDiv && thinkingDiv.parentNode) {
                    messagesContainer.removeChild(thinkingDiv);
                }
                
                // 显示更具体的错误消息
                let errorMessage = '抱歉，发生了错误，请稍后重试。';
                if (error.message.includes('超时')) {
                    errorMessage = '抱歉，服务器响应超时，请稍后重试。';
                } else if (error.message.includes('网络')) {
                    errorMessage = '抱歉，网络连接出现问题，请检查您的网络连接后重试。';
                }
                
                addMessage(errorMessage, 'assistant');
                
                // 记录错误日志
                try {
                    fetch(`${window.location.origin}/api/log-error`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            error: error.message,
                            stack: error.stack,
                            sessionId: currentSessionId,
                            timestamp: new Date().toISOString()
                        })
                    }).catch(err => console.error('记录错误日志时出错:', err));
                } catch (e) {
                    console.error('记录错误日志时出错:', e);
                }
            }
        }

        // 添加消息到界面的函数，支持打字机效果
        function typeWriter(element, text, index = 0, callback) {
            const chunkSize = 3; // 每次添加多个字符
            if (index < text.length) {
                const chunk = text.substr(index, chunkSize);
                element.textContent += chunk;
                requestAnimationFrame(() => typeWriter(element, text, index + chunkSize, callback));
            } else if (callback) {
                callback();
            }
        }

        // 添加消息到界面的函数
        async function addMessage(content, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `<div class="message-content"></div>`;
            messageDiv.style.opacity = '0';
            messagesContainer.appendChild(messageDiv);

            const contentDiv = messageDiv.querySelector('.message-content');
            
            // 判断是否是认知回复（第三段）
            const isCognitiveResponse = type === 'assistant' && 
                content.length > 50 && 
                !content.includes('深夜的杂货店亮着灯') && 
                !content.includes('你现在心情好了一些吗') && 
                !content.includes('唉，这件事确实很难办呢');
                
            // 如果是用户消息或认知回复，添加信件样式类
            if (type === 'user' || isCognitiveResponse) {
                contentDiv.classList.add('letter-style');
            }
            
            // 如果是AI回复，使用打字机效果
            if (type === 'assistant') {
                contentDiv.textContent = '';
                messageDiv.style.opacity = '1';
                messageDiv.style.transition = 'opacity 0.3s ease-in-out';
                typeWriter(contentDiv, content, 0, () => {
                    // 打字机效果完成后渲染Markdown
                    contentDiv.innerHTML = marked.parse(contentDiv.textContent);
                });
            } else {
                contentDiv.innerHTML = marked.parse(content);
                messageDiv.style.opacity = '1';
            }

            // 滚动到最新消息
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);

            // 返回一个Promise以支持分段显示
            return new Promise(resolve => {
                if (type === 'assistant') {
                    setTimeout(resolve, content.length * 10 + 500);
                } else {
                    resolve();
                }
            });
        }
        
        // 保存对话到历史记录
        function saveConversationToHistory() {
            // 获取当前对话内容
            const messages = messagesContainer.querySelectorAll('.message');
            if (messages.length <= 1) return; // 只有欢迎消息，不保存
            
            // 提取用户的第一条消息作为预览
            let preview = "";
            let userMessageFound = false;
            
            for (const msg of messages) {
                if (msg.classList.contains('user') && !userMessageFound) {
                    const content = msg.querySelector('.message-content').textContent.trim();
                    preview = content.length > 50 ? content.substring(0, 50) + '...' : content;
                    userMessageFound = true;
                    break;
                }
            }
            
            if (!preview) return; // 没有找到用户消息，不保存
            
            // 创建历史记录对象
            const conversation = {
                id: currentSessionId,
                timestamp: new Date().toISOString(),
                preview: preview,
                html: messagesContainer.innerHTML
            };
            
            // 获取现有历史记录
            let history = JSON.parse(localStorage.getItem('mailboxHistory') || '[]');
            
            // 检查是否已存在相同ID的对话，如果有则更新
            const existingIndex = history.findIndex(item => item.id === conversation.id);
            if (existingIndex !== -1) {
                history[existingIndex] = conversation;
            } else {
                // 添加新对话到历史记录
                history.unshift(conversation);
            }
            
            // 保存到本地存储
            localStorage.setItem('mailboxHistory', JSON.stringify(history));
            
            // 更新历史对话列表显示
            updateMailboxList();
        }
        
        // 更新历史对话列表显示
        function updateMailboxList(searchTerm = '') {
            // 清空现有列表
            mailboxList.innerHTML = '';
            
            // 获取历史记录
            let history = JSON.parse(localStorage.getItem('mailboxHistory') || '[]');
            
            // 如果有搜索词，进行过滤
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                history = history.filter(item => 
                    item.preview.toLowerCase().includes(term)
                );
            }
            
            // 如果没有历史记录
            if (history.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'empty-mailbox';
                emptyMsg.textContent = searchTerm ? '没有找到匹配的对话' : '信箱里还没有信件';
                emptyMsg.style.padding = '20px';
                emptyMsg.style.textAlign = 'center';
                emptyMsg.style.color = '#718096';
                mailboxList.appendChild(emptyMsg);
                return;
            }
            
            // 添加历史对话项
            history.forEach(item => {
                const mailItem = document.createElement('div');
                mailItem.className = 'mail-item';
                mailItem.dataset.id = item.id;
                
                // 格式化时间
                const date = new Date(item.timestamp);
                const formattedDate = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                
                mailItem.innerHTML = `
                    <div class="mail-time">${formattedDate}</div>
                    <div class="mail-preview">${item.preview}</div>
                    <button class="delete-mail" title="删除此对话">🗑️</button>
                `;
                
                // 点击查看对话
                mailItem.addEventListener('click', (e) => {
                    // 如果点击的是删除按钮，不执行查看操作
                    if (e.target.classList.contains('delete-mail')) return;
                    
                    // 加载对话
                    loadConversation(item.id);
                    
                    // 关闭信箱
                    mailboxContainer.classList.remove('active');
                });
                
                // 删除按钮点击事件
                const deleteBtn = mailItem.querySelector('.delete-mail');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // 阻止事件冒泡
                    deleteConversation(item.id);
                });
                
                mailboxList.appendChild(mailItem);
            });
        }
        
        // 加载对话
        function loadConversation(id) {
            // 获取历史记录
            const history = JSON.parse(localStorage.getItem('mailboxHistory') || '[]');
            const conversation = history.find(item => item.id === id);
            
            if (conversation) {
                // 设置当前会话ID
                currentSessionId = id;
                
                // 加载对话内容
                messagesContainer.innerHTML = conversation.html;
            }
        }
        
        // 删除对话
        function deleteConversation(id) {
            // 获取历史记录
            let history = JSON.parse(localStorage.getItem('mailboxHistory') || '[]');
            
            // 过滤掉要删除的对话
            history = history.filter(item => item.id !== id);
            
            // 保存更新后的历史记录
            localStorage.setItem('mailboxHistory', JSON.stringify(history));
            
            // 更新历史对话列表显示
            updateMailboxList(mailSearch.value.trim());
            
            // 如果删除的是当前对话，创建新对话
            if (id === currentSessionId) {
                createNewConversation();
            }
        }
        
        // 创建新对话
        function createNewConversation() {
            // 生成新的会话ID
            currentSessionId = generateSessionId();
            
            // 清空消息区域，只保留欢迎消息
            messagesContainer.innerHTML = `
                <div class="message assistant">
                    <div class="message-content">
                        🌙 深夜的杂货店亮着灯<br>
                        你好，这里是浪矢爷爷的"解忧信箱"。<br>
                        你可以写下任何心事——关于生活、选择、遗憾，或是某个难以启齿的秘密。<br>
                        请相信："你的地图是白纸，所以一切皆有可能。"<br>
                        我们会像对待30年前的信件一样，认真回复你的每一个字。
                    </div>
                </div>
            `;
            
            // 清空输入框
            userInput.value = '';
        }
        
        // 事件监听器
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // 信箱按钮点击事件
        mailboxBtn.addEventListener('click', () => {
            // 保存当前对话
            saveConversationToHistory();
            
            // 更新历史对话列表
            updateMailboxList();
            
            // 显示信箱
            mailboxContainer.classList.add('active');
        });
        
        // 关闭信箱按钮点击事件
        closeMailbox.addEventListener('click', () => {
            mailboxContainer.classList.remove('active');
        });
        
        // 新信件按钮点击事件
        newLetterBtn.addEventListener('click', () => {
            // 保存当前对话
            saveConversationToHistory();
            
            // 创建新对话
            createNewConversation();
        });
        
        // 搜索框输入事件
        mailSearch.addEventListener('input', () => {
            const searchTerm = mailSearch.value.trim();
            updateMailboxList(searchTerm);
        });
        
        // 初始化时更新历史对话列表
        updateMailboxList();
    </script>
</body>
</html>